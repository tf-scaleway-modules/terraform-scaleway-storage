# =============================================================================
# VALIDATION STAGE - Run on all commits
# =============================================================================

validate:opentofu:
  stage: validate
  image:
    name: ghcr.io/opentofu/opentofu:1.11
    entrypoint: [""]
  rules:
    - when: always
  script:
    - tofu init -backend=false
    - tofu validate
    - tofu fmt -check -recursive
  cache:
    paths:
      - .terraform

validate:tflint:
  stage: validate
  image:
    name: ghcr.io/terraform-linters/tflint:v0.56.0
    entrypoint: [""]
  rules:
    - when: always
  script:
    - tflint --init
    - tflint --recursive

# =============================================================================
# RELEASE STAGE - Only on tags
# =============================================================================

create:release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    # Only run on semantic version tags (e.g., v1.2.3, v2.0.0-beta.1)
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$/
  before_script:
    - apk add --no-cache git
  script:
    # Extract version from tag (remove 'v' prefix)
    - export VERSION=${CI_COMMIT_TAG#v}
    - echo "Creating release for version $VERSION"

    # Extract changelog section for this version
    - |
      if [ -f CHANGELOG.md ]; then
        # Extract the section between current version and previous version/EOF
        RELEASE_NOTES=$(awk "/^## \[$VERSION\]/,/^## \[/" CHANGELOG.md | sed '$d' | tail -n +2)
        if [ -z "$RELEASE_NOTES" ]; then
          RELEASE_NOTES="Release $VERSION - See CHANGELOG.md for details"
        fi
      else
        RELEASE_NOTES="Release $VERSION"
      fi

    # Create release with extracted notes
    - echo "$RELEASE_NOTES" > release_notes.md

  release:
    name: 'Release $CI_COMMIT_TAG'
    description: release_notes.md
    tag_name: '$CI_COMMIT_TAG'
    ref: '$CI_COMMIT_TAG'
    assets:
      links:
        - name: 'Source Code (tar.gz)'
          url: '${CI_PROJECT_URL}/-/archive/${CI_COMMIT_TAG}/${CI_PROJECT_NAME}-${CI_COMMIT_TAG}.tar.gz'
          link_type: 'package'
        - name: 'Source Code (zip)'
          url: '${CI_PROJECT_URL}/-/archive/${CI_COMMIT_TAG}/${CI_PROJECT_NAME}-${CI_COMMIT_TAG}.zip'
          link_type: 'package'
        - name: 'CHANGELOG'
          url: '${CI_PROJECT_URL}/-/blob/${CI_COMMIT_TAG}/CHANGELOG.md'
          link_type: 'other'
